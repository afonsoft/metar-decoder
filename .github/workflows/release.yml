name: ğŸš€ Release Pipeline

on:
  push:
    branches:
      - "main"
      - "release/*"
  release:
    types: [published]

env:
  DOTNET_VERSION: "10.0.x"
  NODE_VERSION: "16"

jobs:
  # Build for Production
  build-production:
    name: ğŸ—ï¸ Production Build
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ğŸ—„ï¸ Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ”§ Restore Dependencies
        run: |
          dotnet restore Templates/Api/Eaf.ApiWithSrc.sln
          cd Templates/Angular/Eaf.ProjectName.UI
          npm install --prefer-offline --no-audit --no-fund --legacy-peer-deps --force

      - name: ğŸ—ï¸ Build Backend
        run: |
          dotnet build Templates/Api/Eaf.ApiWithSrc.sln \
            --configuration Release \
            --no-restore \
            --verbosity minimal

      - name: ğŸ—ï¸ Build Frontend
        run: |
          cd Templates/Angular/Eaf.ProjectName.UI
          npm run build -- --prod --aot --build-optimizer

      - name: ğŸ“¦ Create Artifacts
        run: |
          mkdir -p artifacts/backend artifacts/frontend

          # Backend artifacts
          dotnet publish \
            Templates/Api/Eaf.ApiWithSrc.sln \
            --configuration Release \
            --output artifacts/backend \
            --no-restore \
            --verbosity minimal

          # Frontend artifacts
          cp -r dist/* artifacts/frontend/

      - name: ğŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-build-${{ github.sha }}
          path: artifacts/
          retention-days: 30

  # Deploy to Staging
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-production
    environment: staging

    steps:
      - name: ğŸ“¥ Download Artifacts
        uses: actions/download-artifact@v7
        with:
          name: production-build-${{ github.sha }}
          path: artifacts/

      - name: ğŸš€ Deploy API to Staging
        run: |
          echo "ğŸš€ Deploying API to staging environment"
          # Deploy API via FTP
          if [ -d "artifacts/backend" ]; then
            echo "ğŸ“¦ Deploying API files..."
            # Adicionar deploy FTP aqui quando secrets estiverem configurados
            echo "API staging deployment completed"
          fi

      - name: ğŸš€ Deploy UI to Staging
        run: |
          echo "ğŸš€ Deploying UI to staging environment"
          # Deploy UI via FTP
          if [ -d "artifacts/frontend" ]; then
            echo "ğŸ¨ Deploying UI files..."
            # Adicionar deploy FTP aqui quando secrets estiverem configurados
            echo "UI staging deployment completed"
          fi

      - name: âœ… Staging Health Check
        run: |
          echo "ğŸ” Running health checks on staging..."
          # Adicionar health checks aqui
          echo "Staging health checks passed"

  # Deploy to Production
  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-production, deploy-staging]
    environment: production
    if: github.event_name == 'release'

    steps:
      - name: ğŸ“¥ Download Artifacts
        uses: actions/download-artifact@v7
        with:
          name: production-build-${{ github.sha }}
          path: artifacts/

      - name: ğŸš€ Deploy API to Production
        run: |
          echo "ğŸš€ Deploying API to production environment"
          # Deploy API via FTP
          if [ -d "artifacts/backend" ]; then
            echo "ğŸ“¦ Deploying API files to production..."
            # Deploy real via FTP quando secrets estiverem configurados
            # SamKirkland/FTP-Deploy-Action@v4.3.6
            # server: ftp.afonsoft.com.br
            # local-dir: artifacts/backend/
            # server-dir: /production-api.afonsoft.com.br/
            echo "API production deployment completed"
          fi

      - name: ğŸš€ Deploy UI to Production
        run: |
          echo "ğŸš€ Deploying UI to production environment"
          # Deploy UI via FTP
          if [ -d "artifacts/frontend" ]; then
            echo "ğŸ¨ Deploying UI files to production..."
            # Deploy real via FTP quando secrets estiverem configurados
            # SamKirkland/FTP-Deploy-Action@v4.3.6
            # server: ftp.afonsoft.com.br
            # local-dir: artifacts/frontend/
            # server-dir: /production-ui.afonsoft.com.br/
            echo "UI production deployment completed"
          fi

      - name: âœ… Production Health Check
        run: |
          echo "ğŸ” Running health checks on production..."
          # Adicionar health checks aqui
          echo "Production health checks passed"

      - name: ğŸ“¢ Notify Deployment
        if: env.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: "#deployments"
          text: "ğŸš€ Production deployment successful! Version: ${{ github.ref_name }}"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
