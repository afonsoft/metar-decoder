name: ðŸ“Š Code Quality

on:
  workflow_dispatch:
  pull_request:
    branches: [main]
  push:
    branches:
      - main
      - "releases/*"

jobs:
  # Qodana Analysis
  qodana:
    name: ðŸ” Qodana Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      checks: write

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: ðŸ” Qodana Scan
        uses: JetBrains/qodana-action@v2025.3.1
        env:
          QODANA_TOKEN: ${{ secrets.QODANA_TOKEN }}
        with:
          args: --linter,qodana-community-for-net --baseline,qodana.sarif.json --fail-threshold,0
          cache-default-branch-only: true
          upload-result: false
          primary-cache-key: qodana-2025.3-refs/heads/main-${{ github.sha }}
          additional-cache-key: qodana-2025.3-refs/heads/main

      - name: ðŸ“Š Upload Qodana Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: qodana-report
          path: ${{ github.workspace }}/qodana

  # SonarQube Analysis
  sonarqube:
    name: ðŸ“Š SonarQube Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Setup NuGet
        uses: NuGet/setup-nuget@v2.0.1

      - name: ðŸ—„ï¸ Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.0.x"

      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: 17
          distribution: "zulu"

      - name: ðŸ”§ Clear NuGet cache
        run: dotnet nuget locals all --clear

      - name: ðŸ“¦ Install SonarQube Tools
        run: dotnet tool install --global --ignore-failed-sources dotnet-sonarscanner

      - name: ðŸ“¦ Install Coverlet Tools
        run: dotnet tool install --global --ignore-failed-sources coverlet.console

      - name: ðŸ”§ Fix Permission
        run: chmod 777 sonar/ -R || true

      - name: ðŸ” Prepare analysis on SonarQube
        run: |
          echo "ðŸ” Checking SonarQube configuration..."
          if [ -z "${{ secrets.SONAR_TOKEN }}" ]; then
            echo "âŒ SONAR_TOKEN is not set or empty"
            echo "âš ï¸ Skipping SonarQube analysis"
            exit 0
          fi

          echo "âœ… SONAR_TOKEN is configured"
          dotnet sonarscanner begin \
            /o:"afonsoft" \
            /k:"afonsoft_metar-decoder" \
            /d:sonar.host.url="https://sonarcloud.io" \
            /d:sonar.login="${{ secrets.SONAR_TOKEN }}" \
            /d:sonar.scm.provider=git \
            /d:sonar.coverage.exclusions="**Test*.cs"

      - name: ðŸ—ï¸ Build
        run: dotnet build MetarDecoder.sln --configuration release

      - name: ðŸ” Run Code Analysis
        run: |
          echo "ðŸ” Finalizing SonarQube analysis..."
          if [ -z "${{ secrets.SONAR_TOKEN }}" ]; then
            echo "âš ï¸ SONAR_TOKEN not configured, skipping analysis"
            exit 0
          fi

          dotnet sonarscanner end /d:sonar.login="${{ secrets.SONAR_TOKEN }}"

  # Snyk Security Analysis
  snyk:
    name: ðŸ›¡ï¸ Snyk Security
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v6

      - name: ðŸ—„ï¸ Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.0.x"

      - name: ðŸ”§ Restore Dependencies
        run: dotnet restore MetarDecoder.sln --ignore-failed-sources

      - name: ðŸ›¡ï¸ Run Snyk
        uses: snyk/actions/dotnet@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test
          args: --file=MetarDecoder.sln --severity-threshold=high --sarif-file-output=snyk.sarif --json-output=snyk.json

      - name: ðŸ“Š Upload Snyk Results
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('snyk.sarif') != ''
        with:
          sarif_file: snyk.sarif
          category: snyk

      - name: ðŸ“‹ Generate Snyk Summary
        if: always()
        run: |
          echo "## ðŸ›¡ï¸ Snyk Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "snyk.json" ]; then
            echo "### ðŸ“Š Vulnerability Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Extract summary from JSON
            VULNS=$(cat snyk.json | jq -r '.results[0].vulnerabilities | length' 2>/dev/null || echo "0")
            DEPS=$(cat snyk.json | jq -r '.results[0].dependencies | length' 2>/dev/null || echo "0")
            
            echo "- **Dependencies Analyzed**: $DEPS" >> $GITHUB_STEP_SUMMARY
            echo "- **Vulnerabilities Found**: $VULNS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "$VULNS" -gt 0 ]; then
              echo "### âš ï¸ Vulnerabilities Detected" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # Extract vulnerability details
              cat snyk.json | jq -r '.results[0].vulnerabilities[] | 
                "- **\(.severity | ascii_upcase)**: \(.title) in \(.package)@\(.version)"' 2>/dev/null | head -10 >> $GITHUB_STEP_SUMMARY
              
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ðŸ”§ Affected Projects" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # Extract affected projects
              cat snyk.json | jq -r '.results[0].vulnerabilities[] | 
                "- \(.from[0] | split("/")[-1])"' 2>/dev/null | sort -u >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… **No vulnerabilities found!** All dependencies are secure." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ **Snyk scan results not available**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Scan Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Severity Threshold**: High" >> $GITHUB_STEP_SUMMARY
          echo "- **Target**: MetarDecoder.sln" >> $GITHUB_STEP_SUMMARY
          echo "- **Scanner**: Snyk .NET" >> $GITHUB_STEP_SUMMARY

  # Code Quality Metrics
  quality-metrics:
    name: ðŸ“ˆ Quality Metrics
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v6

      - name: ðŸ—„ï¸ Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.0.x"

      - name: ðŸ”§ Restore Dependencies
        run: dotnet restore MetarDecoder.sln --ignore-failed-sources

      - name: ðŸ—ï¸ Build Solution
        run: dotnet build MetarDecoder.sln --configuration Release --no-restore --verbosity minimal

      - name: ðŸ“Š Calculate Metrics
        run: |
          echo "ðŸ“Š Analyzing code quality metrics..."

          # Count lines of code
          echo "Lines of Code: $(find src -name '*.cs' -exec wc -l {} + | tail -1 | awk '{print $1}')"

          # Count test files
          echo "Test Files: $(find tests -name '*Tests.cs' | wc -l)"

          # Count projects
          echo "Projects: $(find src -name '*.csproj' | wc -l)"

          # Check for TODO comments
          echo "TODO Comments: $(grep -r 'TODO' src --include='*.cs' | wc -l)"

          echo "Quality metrics analysis completed!"

  # Quality Summary
  quality-summary:
    name: ðŸ“‹ Quality Summary
    runs-on: ubuntu-latest
    needs: [qodana, sonarqube, snyk, quality-metrics]
    if: always()

    steps:
      - name: ðŸ“‹ Generate Quality Report
        run: |
          echo "## ðŸ“Š Code Quality Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tool | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Qodana | ${{ needs.qodana.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š SonarQube | ${{ needs.sonarqube.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ›¡ï¸ Snyk | ${{ needs.snyk.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ˆ Metrics | ${{ needs.quality-metrics.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.qodana.result }}" == "failure" || "${{ needs.sonarqube.result }}" == "failure" || "${{ needs.snyk.result }}" == "failure" ]]; then
            echo "âŒ **Quality issues detected! Please review the analysis reports.**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **All quality checks passed!**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Quality Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- **Lines of Code**: Calculated during build" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Coverage**: Available in CI pipeline" >> $GITHUB_STEP_SUMMARY
          echo "- **Technical Debt**: Analyzed by Qodana & SonarQube" >> $GITHUB_STEP_SUMMARY
          echo "- **Security**: Scanned by Snyk" >> $GITHUB_STEP_SUMMARY
